name: Bitbucket â†’ GitHub Migration

on:
  workflow_dispatch:   # Run manually

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout empty repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq git

    - name: Get Bitbucket Project + Repo List
      id: list
      run: |
        echo "Fetching Bitbucket repositories..."
        curl -u "${{ secrets.BB_USER }}:${{ secrets.BB_APP_PASSWORD }}" \
          "https://api.bitbucket.org/2.0/repositories/${{ secrets.BITBUCKET_WORKSPACE }}?pagelen=100" \
        | jq -r '.values[] | "\(.project.key),\(.name),\(.links.clone[0].href)"' > repos.csv

        echo "Repos found:"
        cat repos.csv

    - name: Process Each Repository
      run: |
        while IFS=',' read -r PROJECT REPO CLONE_URL
        do
          echo "Migrating: $REPO from project $PROJECT"

          # Clone Bitbucket repo
          git clone --mirror "$CLONE_URL"

          cd "$REPO.git"

          # Create GitHub repo
          echo "Creating GitHub repo: $REPO"
          curl -L \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/repos \
            -d "{\"name\":\"$REPO\"}"

          # Push to GitHub
          echo "Pushing to GitHub..."
          git push --mirror "https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ secrets.GITHUB_ORG }}/$REPO.git"

          cd ..
        done < repos.csv

    - name: Done
      run: echo "Migration complete ðŸŽ‰"
